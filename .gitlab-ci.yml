# .gitlab-ci.yml
stages:
  - build
  - test
  - deploy

variables:
  DOCKER_TLS_CERTDIR: ""  # DÃ©sactiver TLS pour simplifier
  COMPOSE_PROJECT_NAME: frais_mission_ci

# Ã‰tape de build de l'image Docker
build_image:
  stage: build
  image: docker:latest
  services:
    - docker:dind  # Utilise Docker-in-Docker
  script:
    - sleep 10  # Attendre que Docker dÃ©marre
    - docker info
    - echo "ğŸ—ï¸ Build de l'image Django..."
    - docker compose -f docker-compose.prod.yml build web

# Ã‰tape de test de l'application
test_app:
  stage: test
  image: docker:latest
  services:
    - docker:dind
  script:
    - sleep 10
    - echo "ğŸ§ª Tests unitaires..."
    - docker compose -f docker-compose.prod.yml run --rm web python manage.py test
    - echo "âœ… Tests rÃ©ussis"

# Ã‰tape de dÃ©ploiement en production
deploy_prod:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  script:
    - sleep 10
    - echo "ğŸš€ DÃ©ploiement en production..."
    - docker compose -f docker-compose.prod.yml down
    - docker compose -f docker-compose.prod.yml up -d
  only:
    - develop