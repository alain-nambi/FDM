# .gitlab-ci.yml
stages:
  - build
  - test
  - deploy

variables:
  DOCKER_TLS_CERTDIR: ""          # DÃ©sactiver TLS
  DOCKER_HOST: tcp://docker:2375  # Utiliser DinD
  COMPOSE_PROJECT_NAME: frais_mission_ci

build_image:
  stage: build
  image: docker:24.0
  services:
    - name: docker:dind
      alias: docker
  script:
    - sleep 10
    - docker info
    - echo "ğŸ—ï¸ Build de l'image Django..."
    - docker compose -f docker-compose.prod.yml build web

test_app:
  stage: test
  image: docker:24.0
  services:
    - name: docker:dind
      alias: docker
  script:
    - sleep 10
    - echo "ğŸ§ª Tests unitaires..."
    - docker compose -f docker-compose.prod.yml run --rm web python manage.py test
    - echo "âœ… Tests rÃ©ussis"

deploy_prod:
  stage: deploy
  image: docker:24.0
  services:
    - name: docker:dind
      alias: docker
  script:
    - sleep 10
    - echo "ğŸš€ DÃ©ploiement en production..."
    - docker compose -f docker-compose.prod.yml down
    - docker compose -f docker-compose.prod.yml up -d
  only:
    - develop